#include "IRDA.H"
#define	commond0f0h    0xf0
#define	commond0f1h    0xf1
#define	commond0f2h    0xf2
#define	csumcodeformat 0x8

GPIO_InitTypeDef IRDA_InitStructure;

unsigned char const	STandantdata[16]=
{
	0xD4,0x01,0x38,0x01,0xD3,0x01,0x36,0x01,
	0x22,0x01,0x83,0x00,0xB7,0x01,0x37,0x01
};

//wjs;===============
unsigned char const	ToggleBit_Place[7]=
{
	0x06,0x04,0x0A,0x06,0x10,0x04,0x02
};
//wjs;=============
unsigned char const	code_format[csumcodeformat][87]=
{
	{
		0x00,0x00,0x28,0x00,0xFA,0x00,
		0x77,0x01,0x00,0x00,0x28,0x00,0x96,0x01,
		0x13,0x02,0x00,0x00,0xF0,0x00,0x00,0x0C,
		0x00,0xF0,0xA8,0x00,0x25,0x01,0xF0,0x00,
		0x00,0x0C,0x00,0xF0,0xA8,0x00,0x25,0x01,
		0xF1,0x02,0xF1,0x08,0xF2,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00
	},
	{
		0x00,0x00,0x28,
		0x00,0xD4,0x00,0x64,0x01,0x00,0x00,0x28,
		0x00,0x70,0x01,0x1F,0x02,0x00,0x00,0xF1,
		0x05,0xF1,0x06,0xF2,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	},
	{
		0x16,
		0x00,0x23,0x00,0x3E,0x00,0xBB,0x00,0x16,
		0x00,0x23,0x00,0xDA,0x00,0x57,0x01,0x00,
		0x00,0xF1,0x05,0xF1,0x07,0xF2,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	},
	{
		0x01,0x00,0x37,0x00,
		0xDA,0x00,0x70,0x01,0x00,0x00,0x37,0x00,
		0x83,0x01,0x13,0x02,0x00,0x00,0xF0,0x01,
		0x00,0x37,0x00,0xF0,0x8C,0x00,0x28,0x01,
		0xF0,0x01,0x00,0x37,0x00,0xF0,0x8C,0x00,
		0x28,0x01,0xF1,0x04,0xF1,0x06,0xF2,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00
	},
	{
		0x12,0x00,
		0x24,0x00,0x12,0x00,0x24,0x00,0x44,0x00,
		0x1B,0x00,0x2B,0x00,0x1B,0x00,0x01,0x00,
		0xF0,0x6A,0x00,0xE7,0x00,0xF0,0x30,0x00,
		0x3D,0x00,0xF0,0x12,0x00,0x24,0x00,0xF0,
		0x12,0x00,0x24,0x00,0xF0,0x12,0x00,0x24,
		0x00,0xF0,0x12,0x00,0x24,0x00,0xF0,0x12,
		0x00,0x24,0x00,0xF0,0x12,0x00,0x24,0x00,
		0xF0,0x12,0x00,0x24,0x00,0xF0,0x12,0x00,
		0x24,0x00,0xF0,0x31,0x00,0x3D,0x00,0xF0,
		0x31,0x00,0x3D,0x00,0xF1,0x08,0xF1,0x08,
		0xF1,0x08,0xF1,0x08,0xF2
	},
	{
		0x12,0x00,0x24,
		0x00,0x12,0x00,0x24,0x00,0x5A,0x00,0x37,
		0x00,0x3E,0x00,0x1B,0x00,0x01,0x00,0xF0,
		0x6A,0x00,0xE7,0x00,0xF0,0x31,0x00,0x3D,
		0x00,0xF1,0x04,0xF0,0x31,0x00,0x3D,0x00,
		0xF0,0x31,0x00,0x3D,0x00,0xF1,0x08,0xF1,
		0x08,0xF2,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00
	},
	{
		0x28,
		0x00,0x41,0x00,0x28,0x00,0x41,0x00,0x76,
		0x00,0x34,0x00,0x5D,0x00,0x34,0x00,0x01,
		0x01,0xF1,0x08,0xF1,0x06,0xF2,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	},
	{
		0x12,0x00,0x2B,0x00,0x12,0x00,0x2B,0x00,
		0x12,0x00,0x2B,0x00,0x3F,0x00,0x1F,0x00,
		0x01,0x00,0xF0,0x12,0x00,0x2B,0x00,0xF0,
		0x76,0x00,0xC8,0x00,0xF0,0x12,0x00,0x2B,
		0x00,0xF0,0x2F,0x00,0x5D,0x00,0xF0,0x2F,
		0x00,0x5D,0x00,0xF0,0x12,0x00,0x2B,0x00,
		0xF1,0x0D,0xF0,0x12,0x00,0x2B,0x00,0xF0,
		0x38,0x01,0x23,0x0F,0xF0,0x12,0x00,0x2B,
		0x00,0xF0,0x76,0x00,0xC8,0x00,0xF2,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	}
};

void	IRDA_SET_SDA_IN(void){
	IRDA_InitStructure.GPIO_Pin = IRDA_SDA_PIN;
 	IRDA_InitStructure.GPIO_Mode = GPIO_Mode_IPU;
  	IRDA_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
 	GPIO_Init(IRDA_PORT_IO, &IRDA_InitStructure);
}
void	IRDA_SET_SDA_OUT(void){
	IRDA_InitStructure.GPIO_Pin = IRDA_SDA_PIN;
 	IRDA_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
  	IRDA_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
 	GPIO_Init(IRDA_PORT_IO, &IRDA_InitStructure);
}
void	IRDA_SET_SCL_OUT(void){
	IRDA_InitStructure.GPIO_Pin = IRDA_SCL_PIN;
 	IRDA_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
  	IRDA_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
 	GPIO_Init(IRDA_PORT_IO, &IRDA_InitStructure);
}
void	IRDA_SET_BUSY_IN(void){
	IRDA_InitStructure.GPIO_Pin = IRDA_BUSY_PIN;
 	IRDA_InitStructure.GPIO_Mode = GPIO_Mode_IPU;
  	IRDA_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
 	GPIO_Init(IRDA_PORT_IO, &IRDA_InitStructure);
}
void	IRDA_SET_BUSY_OUT(void){
	IRDA_InitStructure.GPIO_Pin = IRDA_BUSY_PIN;
 	IRDA_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
  	IRDA_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
 	GPIO_Init(IRDA_PORT_IO, &IRDA_InitStructure);
}

czx_u8	IRDA_getACKsign(void){
	czx_vu8	ack;
	IRDA_SET_SDA_IN();
	delay_us(160);
	IRDA_SCL_H();
	delay_us(160);
	ack	=	IRDA_GET_DATA();
	delay_us(160);
	IRDA_SCL_L();
	delay_us(160);
	return ack;
}

czx_u16	IRDA_write(czx_vu8 d){
	czx_vu8	d_bit;
	//czx_vu8 i;  
        signed char i ;
	delay_us(40);
	for(i=7;i>=0;i--) {
		delay_us(40);
		d_bit=((d>>i)& 0x01);

		if(d_bit)
			IRDA_SDA_H();
		else
			IRDA_SDA_L();

		delay_us(40);
		IRDA_SCL_H();
		delay_us(40);
		IRDA_SCL_L();		
	}
	return IRDA_getACKsign();
}

czx_u16	IRDA_open(void){
	IRDA_SET_SDA_OUT();
	IRDA_SET_SCL_OUT();
	IRDA_SCL_H();
	IRDA_SDA_H();
	return IRDA_NO_ERROR;
}
czx_u16	IRDA_stop(void){
	IRDA_SET_SDA_OUT();
	IRDA_SET_SCL_OUT();
	IRDA_SCL_L();
	IRDA_SDA_L();
	IRDA_SCL_H();
	delay_us(40);
	IRDA_SDA_H();
	delay_us(40);
	return IRDA_NO_ERROR;
}
czx_u16	IRDA_start(void){
	IRDA_SET_SDA_OUT();
	IRDA_SET_SCL_OUT();
	IRDA_SCL_H();
	IRDA_SDA_H();
	delay_us(80);
	IRDA_SDA_L();
	delay_us(400);
	IRDA_SCL_L();
	delay_us(80);
	return TRUE;
}

void IRDA_tx_data(czx_vu8 *d,czx_vu8 len){
	czx_vu8 i;
	IRDA_open();
	delay_us(40);
	IRDA_SCL_L();	
	delay_us(80);
	IRDA_SCL_H();	
	delay_ms(20);
	IRDA_start();
	delay_us(40);
	for(i=0;i<len;i++){
		IRDA_write(d[i]);
		delay_us(40);
	}
	delay_us(40);
	IRDA_stop();
	delay_us(40);
	IRDA_close();
	delay_us(40);
}

void IRDA_CHIP_INIT(void) {
	IRDA_SDA_H();
	IRDA_SET_SDA_OUT();
	IRDA_SCL_H();
	IRDA_SET_SCL_OUT();
	IRDA_SET_BUSY_IN();
}

void IRDA_GPIO_INIT(void) {
	GPIO_InitTypeDef GPIO_InitStructure;
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB,ENABLE); 
      
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_5|GPIO_Pin_6|GPIO_Pin_7;
 	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
    GPIO_Init(GPIOB, &GPIO_InitStructure);
        
    GPIO_ResetBits(GPIOB,GPIO_Pin_5);
    GPIO_ResetBits(GPIOB,GPIO_Pin_6);
    GPIO_ResetBits(GPIOB,GPIO_Pin_7);
}

void IRDA_INIT(void) {
	IRDA_GPIO_INIT();
	//IRDA_CHIP_INIT();
}
